<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:f="http://xmlns.jcp.org/jsf/core"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
      xmlns:p="http://primefaces.org/ui">
<h:head>
  <title>Asynchronous Processing Demo</title>
  <script type="text/javascript">
    function startAutoRefresh() {
      intervalId = setInterval(function () {
        document.getElementById('progressForm:checkProgressBtn').click();
      }, 1000);
    }

    function stopAutoRefresh() {
      if (intervalId) {
        clearInterval(intervalId);
      }
    }

    var intervalId = null;
  </script>
</h:head>

<h:body data-calc="#{asyncController.calculationInProgress}">
  <h1>Asynchronous Processing Demo</h1>

  <h:messages id="messages" globalOnly="true" styleClass="messages"
              errorClass="error" infoClass="info"/>

  <h:form id="calculationForm">
    <div class="form-group">
      <h:outputLabel for="iterations" value="Number of iterations:"/>
      <h:inputText id="iterations" value="#{asyncController.iterations}"/>
    </div>

    <div class="button-group">
      <p:commandButton value="Start Calculation"
                       action="#{asyncController.startCalculation}"
                       update="calculationForm progressForm messages"
                       disabled="#{asyncController.calculationInProgress}"
                       onclick="startAutoRefresh()"/>

      <p:commandButton value="Cancel"
                       action="#{asyncController.cancelCalculation}"
                       update="calculationForm progressForm messages"
                       disabled="#{!asyncController.calculationInProgress}"
                       onclick="stopAutoRefresh()"/>

      <p:commandButton value="Reset"
                       action="#{asyncController.reset}"
                       update="calculationForm progressForm messages"
                       onclick="stopAutoRefresh()"/>

      <h:button value="Back to Home" outcome="index" style="margin-left: 10px;"/>
    </div>

    <div class="result-container">
      <h:outputText value="Result: #{asyncController.result}"
                    rendered="#{asyncController.result != null}"/>
    </div>
  </h:form>

  <h:form id="progressForm">
    <p:commandButton id="checkProgressBtn"
                     value="Check Progress"
                     action="#{asyncController.checkProgress}"
                     update="calculationForm progressForm messages"
                     style="display: none"/>
    <div class="progress-container">
      <h2>Progress Log</h2>
      <ui:repeat value="#{asyncController.progressMessages}" var="message">
        <div class="progress-message">#{message}</div>
      </ui:repeat>
    </div>
  </h:form>

  <h:outputScript target="body">
    window.onload = function () {
      var calcInProgress = document.body.getAttribute('data-calc');
      if (calcInProgress === 'true') {
        startAutoRefresh();
      }
    };
  </h:outputScript>
</h:body>
</html>
