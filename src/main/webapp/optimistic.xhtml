<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:f="http://xmlns.jcp.org/jsf/core"
      xmlns:p="http://primefaces.org/ui">
<h:head>
  <title>Optimistic Lockingo</title>
  <f:metadata>
    <f:viewAction action="#{optimisticLockController.loadAlbums}" />
  </f:metadata>
</h:head>
<h:body>
  <h:form id="mainForm">
    <p:messages id="messages" autoUpdate="true" showDetail="true" />

    <!-- Step 1 -->
    <p:panel styleClass="#{optimisticLockController.step1Complete ? 'ui-panel-success' : ''}">
      <f:facet name="header"> Step 1: Pick an Album </f:facet>
      <p:selectOneMenu id="albumSelect"
                       value="#{optimisticLockController.selectedAlbumId}"
                       disabled="#{optimisticLockController.step1Complete}">
        <f:selectItem itemLabel="-- Select Album --" itemValue="" noSelectionOption="true"/>
        <f:selectItems value="#{optimisticLockController.availableAlbums}" var="a"
                       itemLabel="#{a.title}" itemValue="#{a.id}"/>
      </p:selectOneMenu>
      <p:commandButton value="Get Reference"
                       action="#{optimisticLockController.step1GetReference}"
                       disabled="#{optimisticLockController.step1Complete}"
                       update=":mainForm:messages :mainForm"/>
    </p:panel>

    <!-- Step 2 -->
    <p:panel styleClass="#{optimisticLockController.step2Complete ? 'ui-panel-success'
                          : not optimisticLockController.step1Complete ? 'ui-panel-disabled' : ''}">
      <f:facet name="header"> Step 2: Simulate Another User's Update</f:facet>
      <p:outputPanel rendered="#{optimisticLockController.selectedAlbum != null}">
        <p>Album: <b>#{optimisticLockController.selectedAlbum.title}</b>,
          Songs: #{optimisticLockController.selectedAlbum.numberOfSongs},
          Version: #{optimisticLockController.selectedAlbum.version}</p>
      </p:outputPanel>
      <p:commandButton value="Update as Other User"
                       action="#{optimisticLockController.step2SimulateOtherUser}"
                       disabled="#{!optimisticLockController.step1Complete or optimisticLockController.step2Complete}"
                       update=":mainForm:messages :mainForm"/>
    </p:panel>

    <!-- Step 3 -->
    <p:panel styleClass="#{optimisticLockController.step3Failed ? 'ui-panel-danger'
                          : not optimisticLockController.step2Complete ? 'ui-panel-disabled' : ''}">
      <f:facet name="header"> Step 3: Try Updating with Stale Data</f:facet>
      <p:inputNumber id="newSongs" value="#{optimisticLockController.newNumberOfSongsValue}"
                     label="New Songs" disabled="#{optimisticLockController.step3Failed}" />
      <p:commandButton value="Update with Stale Reference"
                       action="#{optimisticLockController.step3UpdateWithStaleReference}"
                       disabled="#{!optimisticLockController.step2Complete or optimisticLockController.step3Failed}"
                       update=":mainForm:messages :mainForm"/>
    </p:panel>

    <!-- Step 4 -->
    <p:panel styleClass="#{not optimisticLockController.step3Failed ? 'ui-panel-disabled' : ''}">
      <f:facet name="header"> Step 4: Fix by Getting Fresh Data</f:facet>
      <p:commandButton value="Update with Fresh Reference"
                       action="#{optimisticLockController.step4UpdateWithFreshReference}"
                       disabled="#{!optimisticLockController.step3Failed}"
                       update=":mainForm:messages :mainForm"/>
    </p:panel>

    <!-- Reset / Back -->
    <p:toolbar style="margin-top:1em">
      <p:toolbarGroup>
        <p:commandButton value="Reset" action="#{optimisticLockController.loadAlbums}"
                         update=":mainForm"/>
        <p:button value="Back" outcome="index.xhtml?faces-redirect=true" style="margin-left:1em"/>
      </p:toolbarGroup>
    </p:toolbar>
  </h:form>
</h:body>
</html>
